<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Chess</title>
    <link rel="stylesheet"
          href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.css"
          crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.js"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js" integrity="sha512-oprzqYFJfo4Bx/nNEcSI0xo7ggJrLc+qQ6hrS3zV/Jn0C4dsg4gu+FXW/Vm0jP9CrV7e5e6dcLUYkg3imjfjbw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        #board {
            width: 600px;
            margin: 20px auto;
        }
        #reset {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div id="board"></div>
<button id="reset">Reset Game</button>

<script>
    var config = {
      pieceTheme: 'chessboardjs-1.0.0/img/chesspieces/wikipedia/{piece}.png',
      position: 'start',
      draggable: true,
      onDrop: handleMove
    }
    const board = Chessboard('board', config);
    const game = new Chess();

    function getBoard() {
        fetch('http://127.0.0.1:5000/get_board')
        .then((response) => {
            return response.json();
        }).then((body) => {
            game.load(body['fen']);
            board.position(game.fen());
        });
    }

    function handleMove(source, target) {
        let move = source + target;
        // Automatically promote to Queen if needed
        if (game.get(source).type == "p") {
            if (game.turn() == "w" && target[1] == "8") {
                move += "q";
            } else if (target[1] == "1") {
                move += "q";
            }
        }

        console.log(move);
        const gamemove = game.move({ from: source, to: target, promotion: 'q' });
        console.log("Game move", gamemove);
        if (!gamemove) {
            console.log("Invalid move");
            return 'snapback'; // Invalid move
        }
        /*
        if (board.fen() != game.fen().split(' ')[0]) {
            console.log("Reposition", board.fen(), game.fen().split(' ')[0]);
            board.position(game.fen());
        }*/

        // Todo: update the board with the fen state of game to fix things like en-passant?

        fetch('http://127.0.0.1:5000/make_move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({move})
        }).then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }).then((body) => {
            game.load(body['fen']);
            board.position(game.fen());
        }).catch((e) => {
            console.error("Error", e);
        });
    }

    function reset() {
        fetch('http://127.0.0.1:5000/reset', { method: 'POST' })
        .then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            game.reset();
            board.start();
        });
    }

    document.getElementById('reset').addEventListener('click', reset);

    getBoard();
</script>
</body>
</html>
